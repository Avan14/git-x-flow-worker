// Prisma Schema for GitXFlow Worker Service
// Shared with main Next.js application

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Core Models (Synced from main app)
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  name          String?
  image         String?
  username      String?   @unique

  accounts          Account[]
  scheduledPosts    ScheduledPost[]
  socialConnections SocialConnection[]
  generatedContent  GeneratedContent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  access_token  String?
  refresh_token String?
  expires_at    Int?
  token_type    String?
  scope         String?
  id_token      String?
  session_state String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model GeneratedContent {
  id            String   @id @default(cuid())
  achievementId String
  userId        String
  format        String
  content       String   @db.Text
  wordCount     Int?
  isEdited      Boolean  @default(false)

  // Lifecycle
  status        String   @default("saved") // saved | scheduled | posted
  scheduledAt   DateTime?
  postedAt      DateTime?
  platform      String?
  platformPostId String?
  platformUrl   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  scheduledPosts ScheduledPost[]

  @@index([userId])
  @@index([status])
  @@index([scheduledAt])
}

// ============================================
// Job Queue Models
// ============================================

model ScheduledPost {
  id           String     @id @default(cuid())
  userId       String
  contentId    String
  platform     String     // twitter, linkedin
  scheduledFor DateTime
  status       PostStatus @default(PENDING)
  priority     Int        @default(0) // Higher = more urgent

  // Job tracking
  jobId       String?   @unique // BullMQ job ID
  queuedAt    DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // Platform response
  platformPostId String?
  platformUrl    String?

  // Error handling
  errorMessage  String?   @db.Text
  errorCode     String?
  attempts      Int       @default(0)
  maxRetries    Int       @default(3)
  lastAttemptAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  content GeneratedContent @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@index([status, priority])
  @@index([userId])
  @@index([jobId])
}

enum PostStatus {
  PENDING    // Created, not queued yet
  QUEUED     // Added to queue, waiting
  PROCESSING // Worker is posting
  POSTED     // Successfully posted
  FAILED     // Failed after retries
  CANCELLED  // User cancelled
}

// ============================================
// Social Connections
// ============================================

model SocialConnection {
  id       String @id @default(cuid())
  userId   String
  platform String // twitter, linkedin

  // OAuth tokens (encrypted in application layer)
  accessToken  String   @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime?

  // Platform info
  platformUserId String?
  username       String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId])
  @@index([platform])
}

// ============================================
// Rate Limit Tracking
// ============================================

model RateLimitState {
  id       String @id @default(cuid())
  platform String @unique // twitter

  // Twitter rate limits (50 tweets per 24h for free tier)
  postsRemaining Int       @default(50)
  windowResetAt  DateTime?
  lastPostAt     DateTime?

  // Circuit breaker
  consecutiveFailures Int       @default(0)
  circuitOpenUntil    DateTime?

  updatedAt DateTime @updatedAt
}
